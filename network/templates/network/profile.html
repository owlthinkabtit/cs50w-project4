{% extends "network/layout.html" %}

{% block body %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-1">@{{ profile_user.username }}</h2>
    <div class="text-muted">
      <span id="followers-count">{{ followers_count }}</span> followers · {{ following_count }} following
    </div>
  </div>

  {% if user.is_authenticated and not is_self %}
  <button
    id="followBtn"
    class="btn {% if is_following %}btn-outline-danger{% else %}btn-outline-primary{% endif %}"
  >
    {% if is_following %}Unfollow{% else %}Follow{% endif %}
  </button>
  {% endif %}
</div>

<hr class="mb-4" />

<h4 class="mb-3">Posts</h4>

<div id="post-list">
  {% for post in posts %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">
        <a href="{% url 'profile' post.author.username %}">@{{ post.author.username }}</a>
      </h5>

      <p class="card-text post-content">{{ post.content }}</p>
      <p class="card-text">
        <small class="text-muted">
          {{ post.created_at|date:"F j, Y, g:i a" }}
          {% if post.updated_at and post.updated_at > post.created_at %}
            (edited)
          {% endif %}
          · ❤ {{ post.likes.count }}
        </small>
      </p>

      <div class="d-flex align-items-center gap-2">
        {% if user == post.author %}
        <button
          class="btn btn-sm btn-outline-secondary edit-btn"
          data-id="{{ post.id }}"
        >
          Edit
        </button>
        {% endif %}

        <button
          class="btn btn-sm btn-outline-danger like-btn {% if user.is_authenticated and user in post.likes.all %}active{% endif %}"
          data-id="{{ post.id }}"
          aria-pressed="{% if user.is_authenticated and user in post.likes.all %}true{% else %}false{% endif %}"
          {% if not user.is_authenticated %}disabled title="Log in to like"{% endif %}
        >
          ❤
        </button>
        <span class="like-count" data-id="{{ post.id }}">{{ post.likes.count }}</span>
      </div>
    </div>
  </div>
  {% empty %}
  <p>No posts yet.</p>
  {% endfor %}
</div>

<nav class="d-flex justify-content-between align-items-center mt-4">
  {% if page_obj.has_previous %}
  <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-secondary">← Previous</a>
  {% else %}<span></span>{% endif %}

  <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

  {% if page_obj.has_next %}
  <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-secondary">Next →</a>
  {% else %}<span></span>{% endif %}
</nav>
{% endblock %}

{% block extra_js %}
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");

  
  const followBtn = document.getElementById("followBtn");
  if (followBtn) {
    followBtn.addEventListener("click", async () => {
      followBtn.disabled = true;
      try {
        const res = await fetch("{% url 'toggle_follow' profile_user.username %}", {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken },
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || "Error");

        if (data.state === "followed") {
          followBtn.textContent = "Unfollow";
          followBtn.classList.replace("btn-outline-primary", "btn-outline-danger");
        } else {
          followBtn.textContent = "Follow";
          followBtn.classList.replace("btn-outline-danger", "btn-outline-primary");
        }

        document.getElementById("followers-count").textContent = data.followers;
      } catch (e) {
        console.error(e);
        alert("Network error");
      } finally {
        followBtn.disabled = false;
      }
    });
  }

  
  window.addEventListener("DOMContentLoaded", () => {
    console.log("Profile page JS loaded ✅");
    likeHandlerFactory("post-list");
    editHandlerFactory("post-list");
  });
</script>
{% endblock %}
